---
title: "R Notebook"
output: html_notebook
---

This notebook compares results between Formatted Annual Data and Formatted Annual Data v2. The former was done by J. Stewart, whereas the latter was done by me. Results should be the same but a few inconsistencies were found recently (Apr 2023). So, I'm comparing each one to see where the problem is.

```{r}
rm(list = ls())
library(tidyverse)
library(lubridate)
library(flextable)
library(readr)

source("Piedras_Blancas_fcns.R")

```


```{r}
dir.1 <- "data/Formatted Annual Data/"
dir.2 <- "data/Formatted Annual Data v2/"
data.dir <- "data/All data/"

files.1 <- list.files(path = dir.1, 
                    pattern = "Formatted.csv")

col.def.1 <- cols(Week = col_integer(),
                  Date = col_date(format = "%d-%b-%y"),
                  Effort = col_double(),
                  Sightings = col_integer())

col.def.1.2 <- cols(Week = col_integer(),
                  Date = col_date(format = "%d-%b-%Y"),
                  Effort = col_double(),
                  Sightings = col_integer())

col.def.1.3 <- cols(Week = col_integer(),
                    Date = col_date(format = "%Y-%m-%d"),
                    Effort = col_double(),
                    Sightings = col_integer())

col.def.1.1997 <- cols(Week = col_integer(),
                       Date = col_character(), #date(format = "%d-%b-%y"),
                       Effort = col_double(),
                       Sightings = col_integer())

files.2 <- list.files(path = dir.2, 
                    pattern = "Formatted_inshore_v2.csv")

col.def.2 <- cols(Week = col_integer(),
                  Date = col_date(format = "%Y-%m-%d"),
                  Shift = col_integer(),
                  Effort = col_double(),
                  Sightings = col_integer())

fcn.compare.data <- function(data.1, data.2, year){
  data.1 %>% 
    group_by(Date) %>%
    summarize(daily.effort.1 = sum(Effort),
              daily.sightings.1 = sum(Sightings)) %>%
    mutate(Date.char = as.character(Date)) %>%
    dplyr::select(-Date) -> daily.summary.1 
  
  data.2 %>% 
    group_by(Date) %>%
    summarize(daily.effort.2 = sum(Effort),
              daily.sightings.2 = sum(Sightings)) %>%
    mutate(Date.char = as.character(Date)) %>%
    dplyr::select(-Date) -> daily.summary.2 
  
  daily.summary.1 %>% 
    left_join(daily.summary.2, by = "Date.char") %>%
    mutate(dif.effort = daily.effort.1 - daily.effort.2,
           dif.sightings = daily.sightings.1 - daily.sightings.2) -> daily.summary.1.2

  daily.summary.1.2 %>% 
    filter(!is.na(dif.effort)) %>%
    filter(!is.na(dif.sightings)) -> daily.summary.1.2
  
  p.1 <- ggplot(daily.summary.1.2) +
    geom_point(aes(x = as.Date(Date.char), y = dif.effort)) +
    xlab("Date") + 
    ylab("Differences in effort") +
    ggtitle(year)
    
  p.2 <- ggplot(daily.summary.1.2) +
    geom_point(aes(x = as.Date(Date.char), y = dif.sightings),
               color = "red") +
    xlab("Date") + 
    ylab("Differences in # sightings") +
    ggtitle(year)
  
  p. <- cowplot::plot_grid(p.1, p.2)
  
  out.list <- list(data.1 = data.1,
                   data.2 = data.2,
                   daily.summary.1 = daily.summary.1,
                   daily.summary.2 = daily.summary.2,
                   daily.summary.1.2 = daily.summary.1.2,
                   figure = p.,
                   year = year)
  return(out.list)  
}

```


```{r}
years <- c(1994:2019, 2021, 2022)
col.defs.1 <- list(col.def.1, col.def.1.1997, col.def.1.2, col.def.1.3)
col.defs.1.idx <- c(rep(1, 3), rep(2, 23), 3, 4)

daily.summary.list <- list()
k <- 1

for (k in 1:length(years)){
  
  Y <- years[k]
  
  if (col.defs.1.idx[k] == 2){
    data.1 <- read_csv(file = paste0(dir.1, Y, " Formatted.csv"),
                       col_types = col.defs.1[[col.defs.1.idx[k]]]) %>%
      mutate(Date.1 = as.Date(paste0(Date, "-", Y), format = "%d-%b-%Y")) %>%
      transmute(Week = Week, 
                Date = Date.1, 
                Effort = Effort, 
                Sightings = Sightings)
  } else if (col.defs.1.idx[k] == 4){
    data.1 <- read_csv(file = paste0(dir.1, Y, " Formatted.csv"),
                       col_types = col.defs.1[[col.defs.1.idx[k]]]) 
    
  } else {
    data.1 <- read_csv(file = paste0(dir.1, Y, " Formatted.csv"),
                       col_types = col.defs.1[[col.defs.1.idx[k]]]) 
    
  }
  
  data.2 <- read_csv(file = paste0(dir.2, Y, " Formatted_inshore_v2.csv"),
                     col_types = col.def.2)
  
  daily.summary.list[[k]]  <- fcn.compare.data(data.1, data.2, Y)
  
}


```


1994 

```{r}
Y <- 1994
daily.summary.list[[which(years == Y)]]$figure 
```

There are a lot of differences between the two. Need to look into this a bit more. 

Get the raw data
```{r}
# Code chunk from Extract Excel data.Rmd
dir.name <- paste0("C_C ", Y)
start.time <- "630"

USE THE NEW WAY TO EXTRACT DATA, RATHER THAN COPYING AND PASTING CODE CHUNKS. USE NEW FUNCTION (YET TO BE CREATED) 2023-05-12

xls.files <- list.files(path = paste0(data.dir, dir.name), pattern = ".xls")
xls.file.name.inshore <- paste0(data.dir, dir.name, "/", xls.files[1])
xls.file.name.offshore <- paste0(data.dir, dir.name, "/", xls.files[2])

sheet.name.inshore <- "INSHORE LOG"
sheet.name.offshore <- NULL
col.types.inshore <- c("date", "numeric", "text", "numeric", "numeric",
                       "numeric", "numeric", "text", "text")

col.names.inshore <- c("Date", "Event", "Time", "Obs. Code", "Sea State",
                       "Vis. IN", "Cow  / Calf")

col.types.offshore <- c("date", "numeric", "text", "numeric", "numeric",
                        "numeric", "numeric", "numeric", "text", "text")

col.names.offshore <- c("Date", "Event", "Time", "Obs.", "Sea State",
                        "Vis. Code", "Cow/Calf")

out.list <- get.all.data(sheet.name.inshore, sheet.name.offshore,
                         col.types.inshore, col.types.offshore,
                         col.names.inshore, col.names.offshore,
                         Y, 
                         xls.file.name.inshore, xls.file.name.offshore,
                         start.time)
```


Effort:
```{r}

effort.dif.list <- find.effort.dif(Y, daily.summary.list, out.list)

```

There were `r length(effort.dif.list$date.dif)` differences between the two extraction algorithms for year `r Y`. Many differences come from the first shift starting at 0630, rather than 0700. In the v1 extraction algorithm, the first shift was assumed to start at 0700, so 30 min were removed, whereas the v2 algorithm counts all data. Spot checks show v2 doing a good job counting all. v1 seems to ignore sea state > 4. 

There are a few shift 5... I think they should be deleted. They have been removed. 2023-05-12


Sightings

```{r}

sightings.dif.list <- find.sightings.dif(Y, daily.summary.list, out.list)

```

For the number of sightings, there were `r length(sightings.dif.list$date.dif` differences. Checking each one of them with raw data, v2 seems to be doing the right counts. 



1995 

```{r}
Y <- 1995
daily.summary.list[[which(years == Y)]]$figure 
```

Some differences found... 

Get the raw data
```{r}
# Code chunk from Extract Excel data.Rmd
dir.name <- paste0("C_C ", Y)
start.time <- "700"
xls.files <- list.files(path = paste0(data.dir, dir.name), pattern = ".xls")
xls.file.name.inshore <- paste0(data.dir, dir.name, "/", xls.files[1])
xls.file.name.offshore <- paste0(data.dir, dir.name, "/", xls.files[2])

sheet.name.inshore <- "Inshore Data"
sheet.name.offshore <- "Offshore Data"
col.types.inshore <- c("date", "numeric", "text", "numeric", "text", 
                       "text", "numeric", "numeric", "text", "text", 
                       "text", "text", "text", "text", "text", "text")

col.names.inshore <- c("Date",	"Event Code",	"Time",	"Observer Code",	
                       "Sea State",	"Vis In",	"C/C Pairs")

col.types.offshore <- c("date", "numeric", "text", "numeric", 
                        "text", "text", "numeric", "numeric", 
                        "numeric", "text", "numeric", "text")

col.names.offshore <- c("Date",	"Event",	"Time",	"OBS.", 
                        "Sea", "Vis.", 	"Cow/Calf")

out.list <- get.all.data(sheet.name.inshore, sheet.name.offshore,
                         col.types.inshore, col.types.offshore,
                         col.names.inshore, col.names.offshore,
                         Year, 
                         xls.file.name.inshore, xls.file.name.offshore,
                         start.time)
```


Effort:
```{r}

effort.dif.list <- find.effort.dif(Y, daily.summary.list, out.list)

```


Sightings

```{r}

sightings.dif.list <- find.sightings.dif(Y, daily.summary.list, out.list)

```



1996 

```{r}
daily.summary.list[[which(years == 1996)]]$figure 
```


1997 

```{r}
daily.summary.list[[which(years == 1997)]]$figure 
```

1998 

```{r}
daily.summary.list[[which(years == 1998)]]$figure
```

1999 

```{r}
daily.summary.list[[which(years == 1999)]]$figure
```


2000 

```{r}
daily.summary.list[[which(years == 2000)]]$figure
```


2001 

```{r}
daily.summary.list[[which(years == 2001)]]$figure
```




2002

```{r}
daily.summary.list[[which(years == 2002)]]$figure
```


2003

```{r}
daily.summary.list[[which(years == 2003)]]$figure
```

2004

```{r}
daily.summary.list[[which(years == 2004)]]$figure
```

2005

```{r}
daily.summary.list[[which(years == 2005)]]$figure
```


2006

```{r}
daily.summary.list[[which(years == 2006)]]$figure
```


2007

```{r}
Y <- 2007
daily.summary.list[[which(years == Y)]]$figure
```

2008

```{r}
Y <- 2008

daily.summary.list[[which(years == Y)]]$figure
```


2009

```{r}
Y <- 2009

daily.summary.list[[which(years == Y)]]$figure
```


2010

```{r}
Y <- 2010

daily.summary.list[[which(years == Y)]]$figure
```


2011

```{r}
Y <- 2011

daily.summary.list[[which(years == Y)]]$figure

```


2012

```{r}
Y <- 2012

daily.summary.list[[which(years == Y)]]$figure
```


2013

```{r}
Y <- 2013

daily.summary.list[[which(years == Y)]]$figure
```


2014

```{r}
Y <- 2014

daily.summary.list[[which(years == Y)]]$figure
```


2014

```{r}
Y <- 2014

daily.summary.list[[which(years == Y)]]$figure
```


2015

```{r}
Y <- 2015

daily.summary.list[[which(years == Y)]]$figure
```


2016

```{r}
Y <- 2016

daily.summary.list[[which(years == Y)]]$figure
```


2017

```{r}
Y <- 2017

daily.summary.list[[which(years == Y)]]$figure
```


2018

```{r}
Y <- 2018

daily.summary.list[[which(years == Y)]]$figure
```

2019

```{r}
Y <- 2019

daily.summary.list[[which(years == Y)]]$figure
```


2021

```{r}
Y <- 2021

daily.summary.list[[which(years == Y)]]$figure
```

There are a few discrepancies... 



2022

```{r}
Y <- 2022

daily.summary.list[[which(years == Y)]]$figure
```

In the previous run, ther was no difference in effort. One extra sighting on 2022-03-31 for V1 (4 sightings) compared with V2 (3 sightings). Raw data file (PiedrasBlancas2022SurveyData_postQC_TE.xlsx) contains only three sightings on 2022-03-31. So V2 is correct.

Today... 2023-04-28, there are a lot more differences. Not sure what happened here. I was using old files. Using files that were extracted on 2023-04-19, there was only one difference. Those new files were uploaded to Google folder.



